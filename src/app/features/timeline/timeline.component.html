<section class="timeline">
  <!-- Mobile Instagram-style Filters -->
  <div class="timeline__mobile-filters" *ngIf="isMobile()">
    <!-- Sort Order (outside filters) -->
    <div class="mobile-sort-order">
      <button class="sort-btn" type="button" (click)="toggleOrder()">
        <span class="sort-icon">{{ descending ? '↓' : '↑' }}</span>
        {{ descending ? 'Newest First' : 'Oldest First' }}
      </button>
    </div>

    <!-- Filter by Tag -->
    <div class="mobile-filter-section">
      <button class="mobile-filter-header" type="button" (click)="toggleTagFilter()">
        <span class="filter-title">Filter by Tag</span>
        <span class="filter-count" *ngIf="selectedTags.size">({{ selectedTags.size }})</span>
        <span class="filter-arrow">{{ isTagFilterOpen ? '▲' : '▼' }}</span>
      </button>
      
      <div class="mobile-filter-content" *ngIf="isTagFilterOpen">
        <div class="search-box">
          <input 
            type="text" 
            placeholder="Search tags..." 
            [(ngModel)]="tagSearchQuery"
            class="search-input"
          >
        </div>
        <div class="filter-chips">
          <ng-container *ngFor="let t of filteredTags">
            <button
              class="mobile-chip"
              type="button"
              [class.is-active]="selectedTags.has(getTagLabel(t))"
              [style.--chip-color]="getTagColor(t)"
              (click)="toggleTag(getTagLabel(t))"
            >
              {{ getTagLabel(t) }}
            </button>
          </ng-container>
        </div>
        <button type="button" class="clear-btn" (click)="clearFilters()" *ngIf="selectedTags.size">
          Clear All Tags
        </button>
      </div>
    </div>

    <!-- Cut the bla bla -->
    <div class="mobile-filter-section">
      <label class="mobile-filter-header" style="cursor: pointer;">
        <input type="checkbox" [(ngModel)]="useShortDescriptions" />
        <span class="filter-title" style="margin-left:8px;">Cut the bla bla</span>
      </label>
    </div>

    <!-- Filter by Shape -->
    <div class="mobile-filter-section">
      <button class="mobile-filter-header" type="button" (click)="toggleShapeFilter()">
        <span class="filter-title">Filter by Shape</span>
        <span class="filter-count" *ngIf="raritySelected.size">({{ raritySelected.size }})</span>
        <span class="filter-arrow">{{ isShapeFilterOpen ? '▲' : '▼' }}</span>
      </button>
      
      <div class="mobile-filter-content" *ngIf="isShapeFilterOpen">
        <div class="search-box">
          <input 
            type="text" 
            placeholder="Search shapes..." 
            [(ngModel)]="shapeSearchQuery"
            class="search-input"
          >
        </div>
        <div class="filter-chips">
          <ng-container *ngFor="let shape of filteredShapes">
            <button
              class="mobile-chip"
              type="button"
              [class.is-active]="isShapeSelected(shape.key)"
              (click)="toggleShape(shape.key)"
            >
              {{ shape.label }}
            </button>
          </ng-container>
        </div>
        <button type="button" class="clear-btn" (click)="clearRarity()" *ngIf="raritySelected.size">
          Clear All Shapes
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Card Layout -->
  <div class="mobile-timeline" *ngIf="isMobile()">
    <div class="mobile-event-card" *ngFor="let e of filteredEvents; let i = index">
      <!-- Date Badge -->
      <div class="mobile-event-date">
        {{ e.date | date: 'MMM yyyy' }}
      </div>
      
      <!-- Event Header -->
      <div class="mobile-event-header">
        <div class="mobile-event-title-section">
          <h3 class="mobile-event-title">{{ e.title }}</h3>
          <div class="mobile-event-subtitle" *ngIf="e.subtitle">{{ e.subtitle }}</div>
        </div>
        <div class="mobile-event-logo" *ngIf="getFirstEventLogo(e) as logoData">
          <img 
            [src]="logoData.logo" 
            [alt]="getTagLabel(logoData.tag)" 
            [title]="getTagLabel(logoData.tag)"
            (click)="toggleTag(getTagLabel(logoData.tag))"
          />
        </div>
      </div>
      
      <!-- Event Description -->
      <div class="mobile-event-description" *ngIf="getDescription(e)">
        <p>{{ getDescription(e) }}</p>
      </div>
      
      <!-- Event Media -->
      <div class="mobile-event-media" *ngIf="getEventMedia(e)?.length">
        <ng-container *ngIf="getCurrentMedia(e) as m">
          <img
            *ngIf="!isMediaVideo(m)"
            [src]="getMediaSrc(m)"
            alt=""
            class="mobile-media"
            [class.keep-ratio]="isMediaKeepRatio(m)"
            [class.is-zoom-1]="getMediaZoom(m) === 1"
            [class.is-zoom-2]="getMediaZoom(m) === 2"
            (click)="onMediaClick($event, m)"
          />
          <video
            *ngIf="isMediaVideo(m)"
            [src]="getMediaSrc(m)"
            class="mobile-media"
            [class.keep-ratio]="isMediaKeepRatio(m)"
            [class.is-zoom-1]="getMediaZoom(m) === 1"
            [class.is-zoom-2]="getMediaZoom(m) === 2"
            (dblclick)="onMediaClick($event, m)"
            controls
            playsinline
            preload="metadata"
          ></video>
        </ng-container>
        <div class="mobile-media-nav" *ngIf="hasMultipleMedia(e)">
          <button type="button" class="mobile-nav-btn" (click)="prevMedia(e)">‹</button>
          <div class="mobile-media-dots">
            <div 
              *ngFor="let media of getEventMedia(e); let i = index" 
              class="mobile-media-dot" 
              [class.active]="i === getCurrentMediaIndex(e)"
              (click)="goToMedia(e, i)"
            ></div>
          </div>
          <button type="button" class="mobile-nav-btn" (click)="nextMedia(e)">›</button>
        </div>
      </div>
      
      <!-- Event Tags -->
      <div class="mobile-event-tags" *ngIf="e.tags?.length">
        <span class="mobile-tag" *ngFor="let t of e.tags" [style.--tag-color]="getTagColor(t)">
          {{ getTagLabel(t) }}
        </span>
      </div>
    </div>
  </div>

  <!-- Desktop Timeline Layout -->
  <div class="timeline__content" *ngIf="!isMobile()">
    <div class="timeline__line"></div>

  <article
    class="timeline__item"
    *ngFor="let e of filteredEvents; let i = index"
    [class.is-active]="active === e"
    [style.marginTop.px]="getItemMargin(i)"
  >
    <div
      class="timeline__line-break"
      *ngIf="hasDiscontinuity(i)"
      [style.top.px]="-getItemMargin(i) / 2"
    ></div>
    <div class="timeline__year" *ngIf="isNewYear(i)">{{ e.date | date: 'yyyy' }}</div>
    <div class="timeline__date">{{ e.date | date: 'MMM yyyy' }}</div>
    <button
      class="timeline__dot"
      type="button"
      (click)="toggle(e)"
      (mouseenter)="onEnter(e)"
      (mouseleave)="onLeave(e)"
      [style.--dot-bg]="getDotBackground(e)"
      [class.is-golden]="e.golden"
      [class.is-diamond]="e.diamond"
      [attr.aria-pressed]="active === e"
      aria-label="Toggle event details"
    ></button>
    <!-- Always-visible compact title near the node for quick scanning -->
    <div class="timeline__node-title" *ngIf="!isDisplayed(e)">{{ e.title }}</div>

    <div class="timeline__popover" *ngIf="isDisplayed(e)">
        <div class="timeline__popover-header">
          <div class="timeline__popover-content">
      <h3 class="timeline__title">{{ e.title }}</h3>
      <div class="timeline__subtitle" *ngIf="e.subtitle">{{ e.subtitle }}</div>
          </div>
          <div class="timeline__popover-logo" *ngIf="getFirstEventLogo(e) as logoData">
            <img 
              [src]="logoData.logo" 
              [alt]="getTagLabel(logoData.tag)" 
              [title]="getTagLabel(logoData.tag)"
              (click)="toggleTag(getTagLabel(logoData.tag))"
            />
          </div>
      </div>
        <p class="timeline__desc" *ngIf="getDescription(e)" style="white-space: pre-line;">{{ getDescription(e) }}</p>
      <div class="timeline__media" *ngIf="getEventMedia(e)?.length">
        <ng-container *ngIf="getCurrentMedia(e) as m">
          <img
            *ngIf="!isMediaVideo(m)"
            [src]="getMediaSrc(m)"
            alt=""
            class="media"
            [class.keep-ratio]="isMediaKeepRatio(m)"
            [class.is-zoom-1]="getMediaZoom(m) === 1"
            [class.is-zoom-2]="getMediaZoom(m) === 2"
            (click)="onMediaClick($event, m)"
          />
          <video
            *ngIf="isMediaVideo(m)"
            [src]="getMediaSrc(m)"
            class="media"
            [class.keep-ratio]="isMediaKeepRatio(m)"
            [class.is-zoom-1]="getMediaZoom(m) === 1"
            [class.is-zoom-2]="getMediaZoom(m) === 2"
            (dblclick)="onMediaClick($event, m)"
            controls
            playsinline
            preload="metadata"
          ></video>
        </ng-container>
        <div class="timeline__media-nav" *ngIf="hasMultipleMedia(e)">
            <button type="button" class="media-nav-btn" (click)="prevMedia(e)">‹</button>
            <div class="media-dots">
              <div 
                *ngFor="let media of getEventMedia(e); let i = index" 
                class="media-dot" 
                [class.active]="i === getCurrentMediaIndex(e)"
                (click)="goToMedia(e, i)"
              ></div>
            </div>
            <button type="button" class="media-nav-btn" (click)="nextMedia(e)">›</button>
        </div>
      </div>
      <ul class="timeline__tags" *ngIf="e.tags?.length">
        <li class="timeline__tag" *ngFor="let t of e.tags" [style.--tag-color]="getTagColor(t)">
          <span class="tag__dot" aria-hidden="true"></span>
          {{ getTagLabel(t) }}
        </li>
      </ul>
    </div>
  </article>
  </div>
  
  <!-- Desktop Filters -->
  <aside class="timeline__filters timeline__filters--desktop" [class.is-open]="isFilterPanelOpen" *ngIf="!isMobile()">
    <button class="timeline__filters-toggle" type="button" (click)="toggleFilterPanel()" [attr.aria-expanded]="isFilterPanelOpen" aria-label="Toggle filters">
      <span class="filters-toggle-icon">{{ isFilterPanelOpen ? '✕' : '⚙️' }}</span>
    </button>
    
    <div class="timeline__filters-group" *ngIf="isFilterPanelOpen">
      <span class="timeline__filters-label">Display</span>
      <div class="timeline__chips">
        <button class="chip" type="button" [class.is-active]="useShortDescriptions" (click)="useShortDescriptions = !useShortDescriptions">Cut the bla bla</button>
        <button class="chip" type="button" (click)="toggleOrder()">
          {{ descending ? 'Newest -> Oldest' : 'Oldest -> Newest' }}
        </button>
      </div>
    </div>

    <div class="timeline__filters-group" *ngIf="isFilterPanelOpen">
      <span class="timeline__filters-label">Filter by shape</span>
      <div class="timeline__chips">
        <button class="chip" type="button" [class.is-active]="raritySelected.has('normal')" (click)="toggleRarity('normal')">Circle</button>
        <button class="chip" type="button" [class.is-active]="raritySelected.has('golden')" (click)="toggleRarity('golden')">Square</button>
        <button class="chip" type="button" [class.is-active]="raritySelected.has('diamond')" (click)="toggleRarity('diamond')">Diamond</button>
        <button class="chip chip--clear" type="button" (click)="clearRarity()" *ngIf="raritySelected.size">Clear</button>
      </div>
    </div>

    <div class="timeline__filters-group" *ngIf="isFilterPanelOpen">
      <span class="timeline__filters-label">Filter by tag</span>
      <div class="timeline__chips">
        <ng-container *ngFor="let t of availableTags">
          <button
            class="chip"
            type="button"
            [class.is-active]="selectedTags.has(getTagLabel(t))"
            [style.--chip-color]="getTagColor(t)"
            (click)="toggleTag(getTagLabel(t))"
          >
            <span class="chip__dot" aria-hidden="true"></span>
            {{ getTagLabel(t) }}
          </button>
        </ng-container>
      </div>
      <button class="chip chip--clear" type="button" (click)="clearFilters()" *ngIf="selectedTags.size">Clear</button>
    </div>
  </aside>
</section>

